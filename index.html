<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Froom — Realtime Team Status</title>
<meta name="theme-color" content="#0e1326" />
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#0b1020; --bg2:#0c1326; --panel:#111936; --card:#141f44; --muted:#a8b6d6; --text:#f2f6ff;
    --brand:#6ea8fe; --border:#223057; --radius:18px; --radius-sm:12px;
    --green:#2bd67b; --amber:#ffbe55; --red:#ff5d5d;
    --shadow:0 16px 50px rgba(0,0,0,.35); --space:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .shell{max-width:1000px;margin:0 auto;padding:24px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
  .brand{display:flex;gap:12px;align-items:center;font-weight:800;letter-spacing:.3px}
  .logo{width:34px;height:34px;border-radius:10px;background:#0a122d;border:1px solid var(--border);display:grid;place-items:center;box-shadow:var(--shadow)}
  .tl{width:16px;height:16px;border-radius:50%}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{border:1px solid var(--border);background:rgba(20,31,68,.6);padding:10px 14px;border-radius:999px;color:#fff;cursor:pointer}
  .tab.active{background:var(--brand);border-color:transparent}
  .view{display:none} .view.active{display:block;animation:fade .18s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:0 0 var(--space)}
  label{display:block;margin:10px 0 6px}
  input,select{width:100%;padding:14px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:#0b142f;color:var(--text)}
  button{border:0;border-radius:14px;padding:12px 16px;font-weight:700;color:#fff;background:var(--brand);box-shadow:var(--shadow);cursor:pointer}
  button.ghost{background:transparent;border:1px solid var(--border)}
  .row{display:flex;gap:12px;align-items:center}
  .grow{flex:1}
  .list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
  .item{display:flex;justify-content:space-between;align-items:center;gap:12px;background:rgba(20,31,68,.7);border:1px solid var(--border);border-radius:14px;padding:14px}
  .left{display:flex;gap:12px;align-items:center}
  .avatar{width:42px;height:42px;border-radius:50%;background:#0a122d;border:1px solid var(--border);display:grid;place-items:center;font-weight:800}
  .name{font-weight:800;font-size:16px}
  .sub{color:var(--muted);font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:999px;background:#0a122d}
  .dot{width:10px;height:10px;border-radius:50%}
  /* Dashboard grid */
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
  .cardmini{background:rgba(20,31,68,.75);border:1px solid var(--border);border-radius:16px;padding:16px}
  .big{font-size:18px;font-weight:800}
  .spacer{height:8px}
  .lights button{flex:1}
  .footer{margin-top:22px;color:var(--muted);font-size:12px;display:flex;gap:16px;flex-wrap:wrap}
</style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="brand">
        <div class="logo">
          <!-- inline logo: vertical traffic light -->
          <div style="display:grid;gap:4px">
            <span class="tl" style="background:var(--green)"></span>
            <span class="tl" style="background:var(--amber)"></span>
            <span class="tl" style="background:var(--red)"></span>
          </div>
        </div>
        <div style="font-size:22px">Froom</div>
      </div>
      <div class="row" id="authRow" style="display:none">
        <button id="btnLogout" class="ghost">Logout</button>
      </div>
    </header>

    <!-- Tabs -->
    <div id="navTabs" class="tabs" style="display:none;margin-bottom:12px">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="me">My status</div>
      <div class="tab" data-tab="activity">Activity</div>
    </div>

    <!-- LOGIN -->
    <section id="viewLogin" class="view active card" style="max-width:680px">
      <h2 style="margin-top:0">Sign in</h2>
      <form id="loginForm">
        <label>Practice code</label>
        <input id="practiceCode" placeholder="e.g. Z00085" required />
        <label>Your display name</label>
        <input id="displayName" placeholder="e.g. dr quinn / mary reception" required />
        <div class="spacer"></div>
        <button class="grow" style="width:100%">Enter</button>
        <p class="sub" style="margin-top:10px">Tip: anyone can update their own status or someone else’s from the Overview.</p>
      </form>
    </section>

    <!-- OVERVIEW (list) -->
    <section id="viewOverview" class="view card">
      <div class="row" style="margin-bottom:12px">
        <input id="search" class="grow" placeholder="Search name or location…" />
        <select id="filter">
          <option value="">All</option>
          <option value="free">Free</option>
          <option value="busy">Busy</option>
          <option value="dnd">Do Not Disturb</option>
        </select>
      </div>
      <ul id="members" class="list"></ul>
      <div id="empty" class="sub" style="display:none">No matches. Clear filters or search.</div>
    </section>

    <!-- DASHBOARD (grid) -->
    <section id="viewDashboard" class="view card">
      <div class="grid" id="gridCards"></div>
      <div id="gridEmpty" class="sub" style="display:none">No team members yet.</div>
    </section>

    <!-- MY STATUS -->
    <section id="viewMe" class="view card">
      <h2 style="margin-top:0">My status</h2>
      <div class="row lights" style="gap:10px;margin-bottom:12px">
        <button data-me="free">🟢 Free</button>
        <button data-me="busy">🟠 Busy</button>
        <button data-me="dnd">🔴 DND</button>
      </div>
      <label>Location</label>
      <input id="meLocation" placeholder="e.g. Room 3" />
      <label>Note</label>
      <input id="meNote" placeholder="e.g. With patient until 10:30" />
      <div class="spacer"></div>
      <div class="row"><button id="btnSaveMe" class="grow">Save</button><button id="btnClearNote" class="ghost">Clear note</button></div>
    </section>

    <!-- ACTIVITY -->
    <section id="viewActivity" class="view card">
      <h2 style="margin-top:0">Activity</h2>
      <ul id="activity" class="list"></ul>
      <div class="sub" id="activityEmpty">No activity yet.</div>
    </section>

    <div class="footer">
      <span>© <span id="year"></span> Froom</span>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
    </div>
  </div>

  <!-- Firebase (modular CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, updateDoc,
      onSnapshot, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 👉 1) PASTE YOUR CONFIG
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBF6Nqx8NnYwtus7pTILOI8I6PgPef7MCY",
  authDomain: "froom-d30e4.firebaseapp.com",
  projectId: "froom-d30e4",
  storageBucket: "froom-d30e4.firebasestorage.app",
  messagingSenderId: "1050713519645",
  appId: "1:1050713519645:web:108e7f18fafda3f79338f4",
  measurementId: "G-015SBP02GW"
};

    // ---- init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- helpers/state
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const initials = n => (n||'').split(' ').filter(Boolean).map(x=>x[0]).slice(0,2).join('').toUpperCase();
    const slug = s => (s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const ago = ms => { if(!ms) return ''; const s=Math.floor((Date.now()-ms)/1000); if(s<60) return s+"s ago"; const m=Math.floor(s/60); if(m<60) return m+"m ago"; const h=Math.floor(m/60); return h+"h ago"; };
    const state = { practice:null, meId:null, meName:null, unsubM:null, unsubA:null, members:[], activity:[] };
    $('#year').textContent = new Date().getFullYear();

    // ---- tabs / views
    function setTab(tab){
      $$('.tab').forEach(t=>t.classList.remove('active'));
      $(`.tab[data-tab="${tab}"]`).classList.add('active');
      ['viewOverview','viewDashboard','viewMe','viewActivity','viewLogin'].forEach(id=>$('#'+id).classList.remove('active'));
      if(tab==='overview') $('#viewOverview').classList.add('active');
      if(tab==='dashboard') $('#viewDashboard').classList.add('active');
      if(tab==='me') $('#viewMe').classList.add('active');
      if(tab==='activity') $('#viewActivity').classList.add('active');
    }
    $('#navTabs')?.addEventListener('click', e=>{
      const t=e.target.closest('.tab'); if(!t) return; setTab(t.dataset.tab);
    });

    // ---- listeners
    function listenMembers(){
      if(state.unsubM) state.unsubM();
      const qy = query(collection(db,'practices',state.practice,'members'), orderBy('role'), orderBy('name'));
      state.unsubM = onSnapshot(qy, snap=>{
        state.members = snap.docs.map(d=>({ id:d.id, ...d.data(), _ms:d.data().updatedAt?.toMillis?.() }));
        renderMembers(); renderDashboard(); renderMe();
      });
    }
    function listenActivity(){
      if(state.unsubA) state.unsubA();
      const col = collection(db,'practices',state.practice,'activity');
      state.unsubA = onSnapshot(col, snap=>{
        state.activity = snap.docs.map(d=>({ id:d.id, ...d.data(), _ms:d.data().ts?.toMillis?.() }))
          .sort((a,b)=>b._ms-a._ms);
        renderActivity();
      });
    }

    // ---- renderers
    function statusDot(s){ return s==='free'?'var(--green)':s==='busy'?'var(--amber)':'var(--red)'; }

    function renderMembers(){
      const q=($('#search').value||'').toLowerCase(), filt=$('#filter').value;
      const list=$('#members'); list.innerHTML="";
      const items = state.members
        .filter(m=>!filt || m.status===filt)
        .filter(m=>!q || (m.name||'').includes(q) || (m.location||'').toLowerCase().includes(q));
      $('#empty').style.display = items.length? 'none':'block';

      items.forEach(m=>{
        const li=document.createElement('li'); li.className='item';
        li.innerHTML = `
          <div class="left">
            <div class="avatar">${initials(m.name)}</div>
            <div>
              <div class="name">${m.name}</div>
              <div class="sub">${m.location||''}${m.location&&m.note?' • ':''}${m.note||''}${m._ms? ' • updated '+ago(m._ms):''}</div>
            </div>
          </div>
          <div class="row">
            <span class="pill"><span class="dot" style="background:${statusDot(m.status)}"></span><span>${m.status||'free'}</span></span>
            <button data-id="${m.id}" data-act="free">🟢</button>
            <button data-id="${m.id}" data-act="busy">🟠</button>
            <button data-id="${m.id}" data-act="dnd">🔴</button>
            <button data-id="${m.id}" data-act="note">✏️</button>
          </div>`;
        list.appendChild(li);
      });
    }

    function renderDashboard(){
      const wrap = $('#gridCards'); wrap.innerHTML='';
      const items = state.members;
      $('#gridEmpty').style.display = items.length? 'none':'block';
      items.forEach(m=>{
        const card=document.createElement('div'); card.className='cardmini';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div class="row" style="gap:12px">
              <div class="avatar" style="width:46px;height:46px">${initials(m.name)}</div>
              <div>
                <div class="big">${m.name}</div>
                <div class="sub">${m.location||'—'} ${m._ms? ' • '+ago(m._ms):''}</div>
              </div>
            </div>
            <span class="pill"><span class="dot" style="background:${statusDot(m.status)}"></span>${m.status||'free'}</span>
          </div>
          <div class="spacer"></div>
          <div class="row">
            <button data-id="${m.id}" data-act="free">🟢 Free</button>
            <button data-id="${m.id}" data-act="busy" class="ghost">🟠 Busy</button>
            <button data-id="${m.id}" data-act="dnd"  class="ghost">🔴 DND</button>
            <button data-id="${m.id}" data-act="note" class="ghost">✏️ Note</button>
          </div>`;
        wrap.appendChild(card);
      });
    }

    function renderMe(){
      const me = state.members.find(x=>x.id===state.meId); if(!me) return;
      $('#meLocation').value = me.location||''; $('#meNote').value = me.note||'';
    }

    function renderActivity(){
      const ul=$('#activity'); ul.innerHTML='';
      if(!state.activity.length){ $('#activityEmpty').style.display='block'; return; }
      $('#activityEmpty').style.display='none';
      state.activity.forEach(e=>{
        const li=document.createElement('li'); li.className='item';
        li.textContent = `${new Date(e._ms||Date.now()).toLocaleTimeString()} — ${e.msg}`;
        ul.appendChild(li);
      });
    }

    // ---- writes
    async function ensureMe(){
      state.meId = slug(state.meName);
      const meRef = doc(db,'practices',state.practice,'members',state.meId);
      const snap = await getDoc(meRef);
      if(!snap.exists()){
        await setDoc(meRef,{
          name: state.meName, role:'staff', status:'free', note:'', location:'',
          createdAt: serverTimestamp(), updatedAt: serverTimestamp(), updatedBy: state.meName
        });
      }
    }
    async function log(msg){
      const id = String(Date.now());
      await setDoc(doc(db,'practices',state.practice,'activity',id), { msg, ts: serverTimestamp(), by: state.meName }, { merge:true });
    }
    async function updateMember(id, data){
      await updateDoc(doc(db,'practices',state.practice,'members',id), { ...data, updatedAt: serverTimestamp(), updatedBy: state.meName });
      await log(`${state.meName} set ${id} → ${data.status || 'updated'}`);
      navigator.vibrate?.(15);
    }

    // ---- events
    $('#loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      state.practice = $('#practiceCode').value.trim().toUpperCase();
      state.meName = $('#displayName').value.trim().toLowerCase();
      if(!state.practice || !state.meName) return alert('Enter practice and name');

      await signInAnonymously(auth);
      await ensureMe();
      listenMembers(); listenActivity();

      // show app chrome
      $('#viewLogin').classList.remove('active');
      $('#navTabs').style.display='flex';
      $('#authRow').style.display='flex';
      setTab('overview'); // default
    });

    $('#btnLogout').addEventListener('click',()=>location.reload());

    // my panel
    $$('[data-me]').forEach(b=>b.addEventListener('click', ()=> updateMember(state.meId, { status:b.dataset.me })));
    $('#btnSaveMe').addEventListener('click', ()=> updateMember(state.meId, { location:$('#meLocation').value.trim(), note:$('#meNote').value.trim() }));
    $('#btnClearNote').addEventListener('click', ()=> $('#meNote').value='');

    // overview & dashboard quick actions
    function actionClick(e){
      const btn=e.target.closest('button'); if(!btn) return;
      const id=btn.dataset.id, act=btn.dataset.act;
      if(!id || !act) return;
      if(act==='note'){ const m=state.members.find(x=>x.id===id); const note=prompt(`Note for ${m?.name||id}`, m?.note||''); if(note!=null) updateMember(id,{note}); }
      else updateMember(id,{status:act});
    }
    $('#members').addEventListener('click', actionClick);
    $('#gridCards').addEventListener('click', actionClick);

    // filters
    $('#search').addEventListener('input', renderMembers);
    $('#filter').addEventListener('change', renderMembers);
  </script>
</body>
</html>
