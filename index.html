<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Froom — Team Status</title>
  <meta name="theme-color" content="#0b1020"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0b1020; --bg2:#0c1326; --panel:#0f1735; --card:#121f46;
      --text:#f3f7ff; --muted:#9fb0cf; --border:#223057; --brand:#6ea8fe;
      --green:#2bd67b; --amber:#ffbe55; --red:#ff5d5d;
      --radius:20px; --rsm:14px; --shadow:0 18px 60px rgba(0,0,0,.35);
      --space:22px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .shell{max-width:980px;margin:0 auto;padding:18px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.3px}
    .logo{width:36px;height:36px;border-radius:10px;background:#09122e;border:1px solid var(--border);
          display:grid;place-items:center;box-shadow:var(--shadow)}
    .tl{width:16px;height:16px;border-radius:50%}
    .nav{display:none;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:rgba(18,31,70,.65);padding:10px 14px;border-radius:999px}
    .chip.active{background:var(--brand);border-color:transparent}
    .view{display:none} .view.active{display:block;animation:fade .18s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
          box-shadow:var(--shadow);padding:18px;margin:0 0 var(--space)}
    label{display:block;margin:10px 0 6px}
    input,select{width:100%;padding:14px;border-radius:var(--rsm);border:1px solid var(--border);
                 background:#0a142f;color:var(--text)}
    button{border:0;border-radius:14px;padding:12px 16px;font-weight:700;color:#fff;background:var(--brand);box-shadow:var(--shadow)}
    button.ghost{background:transparent;border:1px solid var(--border)}
    .row{display:flex;gap:12px;align-items:center} .grow{flex:1}
    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;gap:12px;background:rgba(18,31,70,.7);
          border:1px solid var(--border);border-radius:16px;padding:14px}
    .left{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:50%;background:#09122e;border:1px solid var(--border);
            display:grid;place-items:center;font-weight:900}
    .name{font-weight:900} .sub{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);
          padding:8px 10px;border-radius:999px;background:#0a142f}
    .dot{width:10px;height:10px;border-radius:50%}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(230px,1fr))}
    .mini{background:rgba(18,31,70,.75);border:1px solid var(--border);border-radius:18px;padding:16px}
    .big{font-size:18px;font-weight:900}
    .spacer{height:10px}
    .footer{margin-top:12px;color:var(--muted);font-size:12px;display:flex;gap:12px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="brand">
        <div class="logo">
          <div style="display:grid;gap:4px">
            <span class="tl" style="background:var(--green)"></span>
            <span class="tl" style="background:var(--amber)"></span>
            <span class="tl" style="background:var(--red)"></span>
          </div>
        </div>
        <div style="font-size:22px">Froom</div>
      </div>
      <div id="authArea" class="row" style="display:none">
        <span id="who" class="sub"></span>
        <button id="btnLogout" class="ghost">Logout</button>
      </div>
    </header>

    <!-- tabs -->
    <nav id="tabs" class="nav">
      <button class="chip active" data-tab="overview">Overview</button>
      <button class="chip" data-tab="dashboard">Dashboard</button>
      <button class="chip" data-tab="me">My status</button>
      <button class="chip" data-tab="activity">Activity</button>
    </nav>

    <!-- login / user creation -->
    <section id="viewLogin" class="view active card" style="max-width:680px">
      <h2 style="margin-top:0">Sign in / Create user</h2>
      <form id="loginForm">
        <label>Practice code (Z00…)</label>
        <input id="practiceCode" placeholder="e.g. Z00085" required />
        <div class="row">
          <div class="grow">
            <label>Display name</label>
            <input id="displayName" placeholder="e.g. dr quinn / mary reception" required />
          </div>
          <div style="width:140px">
            <label>Role</label>
            <select id="role">
              <option value="doctor">Doctor</option>
              <option value="reception">Reception</option>
              <option value="nurse">Nurse</option>
              <option value="staff">Staff</option>
            </select>
          </div>
        </div>
        <div class="spacer"></div>
        <button style="width:100%">Enter</button>
        <p class="sub" style="margin-top:8px">
          First time with a code? The practice and your user will be created automatically.
        </p>
      </form>
    </section>

    <!-- overview -->
    <section id="viewOverview" class="view card">
      <div class="row" style="margin-bottom:12px">
        <input id="search" class="grow" placeholder="Search name or location…"/>
        <select id="filter">
          <option value="">All</option>
          <option value="free">Free</option>
          <option value="busy">Busy</option>
          <option value="dnd">Do Not Disturb</option>
        </select>
      </div>
      <ul id="members" class="list"></ul>
      <div id="empty" class="sub" style="display:none">No matches. Clear filters or search.</div>
    </section>

    <!-- dashboard -->
    <section id="viewDashboard" class="view card">
      <div class="grid" id="grid"></div>
      <div id="gridEmpty" class="sub" style="display:none">No people yet.</div>
    </section>

    <!-- my status -->
    <section id="viewMe" class="view card">
      <h2 style="margin-top:0">My status</h2>
      <div class="row" style="gap:10px;margin-bottom:12px">
        <button data-me="free">🟢 Free</button>
        <button data-me="busy" class="ghost">🟠 Busy</button>
        <button data-me="dnd"  class="ghost">🔴 DND</button>
      </div>
      <label>Location</label>
      <input id="meLocation" placeholder="e.g. Room 3"/>
      <label>Note</label>
      <input id="meNote" placeholder="e.g. With patient until 10:30"/>
      <div class="spacer"></div>
      <div class="row"><button id="btnSaveMe" class="grow">Save</button><button id="btnClear" class="ghost">Clear note</button></div>
    </section>

    <!-- activity -->
    <section id="viewActivity" class="view card">
      <h2 style="margin-top:0">Activity</h2>
      <ul id="activity" class="list"></ul>
      <div id="actEmpty" class="sub">No activity yet.</div>
    </section>

    <footer class="footer">
      <span>© <span id="year"></span> Froom</span>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
    </footer>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, collection, onSnapshot, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // 🔧 PASTE YOUR FIREBASE CONFIG HERE
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBF6Nqx8NnYwtus7pTILOI8I6PgPef7MCY",
  authDomain: "froom-d30e4.firebaseapp.com",
  projectId: "froom-d30e4",
  storageBucket: "froom-d30e4.firebasestorage.app",
  messagingSenderId: "1050713519645",
  appId: "1:1050713519645:web:108e7f18fafda3f79338f4",
  measurementId: "G-015SBP02GW"
};
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- helpers/state
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const slug = s => (s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  const initials = n => (n||'').split(' ').filter(Boolean).map(x=>x[0]).slice(0,2).join('').toUpperCase();
  const ago = ms => { if(!ms) return ''; const s=Math.floor((Date.now()-ms)/1000); if(s<60) return s+"s ago"; const m=Math.floor(s/60); if(m<60) return m+"m ago"; const h=Math.floor(m/60); return h+"h ago"; };

  const state = { practice:null, meId:null, meName:null, role:'staff', members:[], activity:[], unsubM:null, unsubA:null };

  $('#year').textContent = new Date().getFullYear();

  // --- tabs / views
  function showApp(){
    $('#viewLogin').classList.remove('active');
    $('#tabs').style.display='flex';
    $('#authArea').style.display='flex';
    setTab('overview');
  }
  function setTab(tab){
    $$('.chip').forEach(c=>c.classList.remove('active'));
    $(`.chip[data-tab="${tab}"]`).classList.add('active');
    ['viewOverview','viewDashboard','viewMe','viewActivity'].forEach(id=>$('#'+id).classList.remove('active'));
    if(tab==='overview') $('#viewOverview').classList.add('active');
    if(tab==='dashboard') $('#viewDashboard').classList.add('active');
    if(tab==='me') $('#viewMe').classList.add('active');
    if(tab==='activity') $('#viewActivity').classList.add('active');
  }
  $('#tabs').addEventListener('click',e=>{const t=e.target.closest('.chip'); if(t) setTab(t.dataset.tab)});

  // --- login / create user / auto-create practice
  $('#loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    state.practice = $('#practiceCode').value.trim().toUpperCase();
    state.meName   = $('#displayName').value.trim();
    state.role     = $('#role').value || 'staff';
    if(!state.practice || !/^Z\d{5}$/i.test(state.practice)) return alert('Enter a valid practice code like Z00085');
    if(!state.meName) return alert('Enter your display name');

    await signInAnonymously(auth);

    // ensure practice exists
    const pracRef = doc(db,'practices',state.practice);
    const pracSnap= await getDoc(pracRef);
    if(!pracSnap.exists()){
      await setDoc(pracRef,{ createdAt: serverTimestamp(), createdBy: state.meName });
    }

    // ensure my member exists (this is the "user creation")
    state.meId = slug(state.meName);
    const meRef = doc(db,'practices',state.practice,'members',state.meId);
    const meSnap= await getDoc(meRef);
    if(!meSnap.exists()){
      await setDoc(meRef,{
        name: state.meName, role: state.role, status:'free', note:'', location:'',
        createdAt: serverTimestamp(), updatedAt: serverTimestamp(), updatedBy: state.meName
      });
    }

    $('#who').textContent = `${state.meName} • ${state.practice}`;
    listenMembers(); listenActivity();
    showApp();
  });

  $('#btnLogout').addEventListener('click',()=>location.reload());

  // --- realtime listeners
  function listenMembers(){
    if(state.unsubM) state.unsubM();
    const qy = query(collection(db,'practices',state.practice,'members'), orderBy('role'), orderBy('name'));
    state.unsubM = onSnapshot(qy, snap=>{
      state.members = snap.docs.map(d=>({ id:d.id, ...d.data(), _ms:d.data().updatedAt?.toMillis?.() }));
      renderMembers(); renderGrid(); renderMe();
    });
  }
  function listenActivity(){
    if(state.unsubA) state.unsubA();
    state.unsubA = onSnapshot(collection(db,'practices',state.practice,'activity'), snap=>{
      state.activity = snap.docs.map(d=>({ id:d.id, ...d.data(), _ms:d.data().ts?.toMillis?.() })).sort((a,b)=>b._ms-a._ms);
      renderActivity();
    });
  }

  // --- renders
  function statusColor(s){ return s==='free'?'var(--green)':s==='busy'?'var(--amber)':'var(--red)'; }

  function renderMembers(){
    const q=($('#search').value||'').toLowerCase(), filt=$('#filter').value;
    const list=$('#members'); list.innerHTML='';
    const items = state.members
      .filter(m=>!filt || m.status===filt)
      .filter(m=>!q || (m.name||'').toLowerCase().includes(q) || (m.location||'').toLowerCase().includes(q));
    $('#empty').style.display = items.length? 'none':'block';
    items.forEach(m=>{
      const li=document.createElement('li'); li.className='item';
      li.innerHTML = `
        <div class="left">
          <div class="avatar">${initials(m.name)}</div>
          <div>
            <div class="name">${m.name}</div>
            <div class="sub">${m.role||''}${m.role?' • ':''}${m.location||'—'}${m._ms?' • updated '+ago(m._ms):''}</div>
          </div>
        </div>
        <div class="row">
          <span class="pill"><span class="dot" style="background:${statusColor(m.status)}"></span>${m.status||'free'}</span>
          <button data-id="${m.id}" data-act="free">🟢</button>
          <button data-id="${m.id}" data-act="busy" class="ghost">🟠</button>
          <button data-id="${m.id}" data-act="dnd"  class="ghost">🔴</button>
          <button data-id="${m.id}" data-act="note" class="ghost">✏️</button>
        </div>`;
      list.appendChild(li);
    });
  }

  function renderGrid(){
    const wrap=$('#grid'); wrap.innerHTML='';
    const items=state.members; $('#gridEmpty').style.display = items.length? 'none':'block';
    items.forEach(m=>{
      const card=document.createElement('div'); card.className='mini';
      card.innerHTML=`
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row" style="gap:12px">
            <div class="avatar" style="width:48px;height:48px">${initials(m.name)}</div>
            <div>
              <div class="big">${m.name}</div>
              <div class="sub">${m.location||'—'} ${m._ms?' • '+ago(m._ms):''}</div>
            </div>
          </div>
          <span class="pill"><span class="dot" style="background:${statusColor(m.status)}"></span>${m.status||'free'}</span>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button data-id="${m.id}" data-act="free">🟢 Free</button>
          <button data-id="${m.id}" data-act="busy" class="ghost">🟠 Busy</button>
          <button data-id="${m.id}" data-act="dnd"  class="ghost">🔴 DND</button>
          <button data-id="${m.id}" data-act="note" class="ghost">✏️ Note</button>
        </div>`;
      wrap.appendChild(card);
    });
  }

  function renderMe(){
    const me = state.members.find(x=>x.id===state.meId); if(!me) return;
    $('#meLocation').value = me.location||''; $('#meNote').value = me.note||'';
  }

  function renderActivity(){
    const ul=$('#activity'); ul.innerHTML='';
    if(!state.activity.length){ $('#actEmpty').style.display='block'; return; }
    $('#actEmpty').style.display='none';
    state.activity.forEach(a=>{
      const li=document.createElement('li'); li.className='item';
      li.textContent = `${new Date(a._ms||Date.now()).toLocaleTimeString()} — ${a.msg}`;
      ul.appendChild(li);
    });
  }

  // --- writes + logging
  async function log(msg){
    const id=String(Date.now());
    await setDoc(doc(db,'practices',state.practice,'activity',id), { msg, ts: serverTimestamp(), by: state.meName }, { merge:true });
  }
  async function updateMember(id, data){
    await updateDoc(doc(db,'practices',state.practice,'members',id), { ...data, updatedAt: serverTimestamp(), updatedBy: state.meName });
    await log(`${state.meName} set ${id} → ${data.status || 'updated'}`);
    navigator.vibrate?.(15);
  }

  // quick actions
  function handleAction(e){
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id, act=b.dataset.act; if(!id||!act) return;
    if(act==='note'){ const m=state.members.find(x=>x.id===id); const note=prompt(`Note for ${m?.name||id}`, m?.note||''); if(note!=null) updateMember(id,{note}); }
    else updateMember(id,{status:act});
  }
  $('#members').addEventListener('click',handleAction);
  $('#grid').addEventListener('click',handleAction);

  // my panel
  $$('[data-me]').forEach(b=>b.addEventListener('click',()=> updateMember(state.meId,{status:b.dataset.me})));
  $('#btnSaveMe').addEventListener('click',()=> updateMember(state.meId,{location:$('#meLocation').value.trim(), note:$('#meNote').value.trim()}));
  $('#btnClear').addEventListener('click',()=> $('#meNote').value='');

  // filters
  $('#search').addEventListener('input',renderMembers);
  $('#filter').addEventListener('change',renderMembers);

  // PWA
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
</script>
</body>
</html>
